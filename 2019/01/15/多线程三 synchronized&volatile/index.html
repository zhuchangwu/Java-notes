<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="author" content="赐我白日梦">
    
    <meta name="description" content="随笔">
    
    
    
    
    
    
    <title>多线程三 synchronized&amp;volatile | 随笔</title>
    <!-- inject:style -->
    <link href="/css/style.css" rel="stylesheet" type="text/css">
    <!-- endinject -->
    <style>
        .cube-loading {
            top: 0;
            position: fixed;
            width: 100%;
            height: 100%;
            background: url('/images/lg/loading.gif') no-repeat center center;
            background-color: rgba(0,0,0,.7);
        }

        .cube-loading.out {
            display: none;
        }

        .cube-loading:before {
            display: block;
            content: 'Loading';
            position: relative;
            width: 100%;
            top: 50%;
            right: -50%;
            color: #fff;
        }

        @media(max-width: 768px) {
            .cube-loading:before {
                font-size: 1.2em;
                transform: translate(-24px,20px);
                -webkit-transform: translate(-24px,20px);
                -o-transform: translate(-24px,20px);
                -ms-transform: translate(-24px,20px);
            }
        }

        @media(min-width: 768px) {
            .cube-loading:before {

            }
        }
    </style>
    
</head></html>
<body>
<div class="cube-body">
    <nav id="cube-top-memu" class="cube-menu">
    <ul class="cube-menu-collapse">
        
        <li>
            <i class="cube-icon cube-icon-home" aria-hidden="true"></i>
            <a href="/">首页</a>
        </li>
        
        <li>
            <i class="cube-icon cube-icon-archive" aria-hidden="true"></i>
            <a href="/archives">归档</a>
        </li>
        
        <li>
            <i class="cube-icon cube-icon-categories" aria-hidden="true"></i>
            <a href="/categories">分类</a>
        </li>
        
        <li>
            <i class="cube-icon cube-icon-tags" aria-hidden="true"></i>
            <a href="/tags">标签</a>
        </li>
        
        <li>
            <i class="cube-icon cube-icon-about" aria-hidden="true"></i>
            <a href="/about-me">关于我</a>
        </li>
        
    </ul>
</nav>
<nav class="cube-side-menu" id="cube-side-menu">
    <ul class="cube-menu-list">
        
        <li>
            <a class="lrc-control">Open Lyrics</a>
        </li>
        
        <li>
            <a class="scroll-to-top">Top</a>
        </li>
    </ul>
</nav>
    <header class="cube-header" id="cube-header">
    <img src=" http://cube-1252774894.cosgz.myqcloud.com/background.png " alt="头部背景图片">
    
    <div class="cube-type">
        <span class="cube-typed-title">senrenbankaの部落格</span>
        <span class="cube-typed-cursor">|</span>
    </div>
    
</header>

    <style>
        nav.cube-menu:before {
            content: '';
            visibility: hidden;
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 44px;
        
            filter: blur(5px);
            -webkit-filter: blur(5px);
        
            z-index: -1;
            background-image: url('http://cube-1252774894.cosgz.myqcloud.com/background.png');
            background-repeat: no-repeat;
            background-position: center -356px;
            background-size: cover;
            background-color: transparent;
        }

        header.cube-background.cube-header-background {
            visibility: hidden;
            background-image: url('http://cube-1252774894.cosgz.myqcloud.com/background.png');
            background-position: center -400px;
        }
    </style>
    <header class="cube-background cube-header-background">
        
        <div class="cube-type">
            <span class="cube-typed-title">senrenbankaの部落格</span>
            <span class="cube-typed-cursor">|</span>
        </div>
        
    </header>
    <div class="load-header-background"></div>
    <script>
        (function (window) {

            window.headerModule = {}
            window.headerModule.image = {
                width: '2000',
                height: '1414'
            }

        })(window)
    </script>
    
    <div class="cube-content">
        <div class="cube-left">
            <div class="cube-article">
    <h1 class="title">多线程三 synchronized&amp;volatile</h1>
    
    <div class="cube-article-header">
        <div class="cube-article-date">
            <i class="cube-icon cube-icon-date" aria-hidden="true"></i>
            <!-- moment.js对象 -->
            2019-01-15
        </div>
        <div class="cube-article-tags">
    <i class="cube-icon cube-icon-tag" aria-hidden="true"></i>
    
    <a href="/tags/多线程/">#多线程</a>
    
</div>
    </div>
    
    <div class="cube-article-content cube-markdown">
        
        <h2 id="synchronized-JVM实现的锁"><a href="#synchronized-JVM实现的锁" class="headerlink" title="synchronized(JVM实现的锁)"></a>synchronized(JVM实现的锁)</h2><blockquote>
<p>通过这两个关键字,我们可以很容易的实现同步多个任务的行为,可以实现同一时刻,只能有一条线程去访问共享资源<a id="more"></a></p>
</blockquote>
<h3 id="一-修饰普通方法"><a href="#一-修饰普通方法" class="headerlink" title="一: 修饰普通方法"></a>一: 修饰普通方法</h3><h4 id="多个线程-共同去竞争访问-方法内部的变量-永远是线程安全的"><a href="#多个线程-共同去竞争访问-方法内部的变量-永远是线程安全的" class="headerlink" title="多个线程,共同去竞争访问,方法内部的变量,永远是线程安全的!!!"></a>多个线程,共同去竞争访问,<strong>方法内部的变量</strong>,永远是线程安全的!!!</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HasSelfPrivateNum</span></span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span>  <span class="title">add</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="keyword">int</span> num=<span class="number">0</span>;  <span class="comment">//num在方法内部,永远是线程安全的!!!</span></span><br><span class="line">         <span class="keyword">if</span>(name.equals(<span class="string">"a"</span>)&#123;</span><br><span class="line">            num =<span class="number">100</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            num =<span class="number">200</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    System.out.println(<span class="string">"num=="</span>+num);    </span><br><span class="line">        </span><br><span class="line">    &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="多个线程-共同去竞争访问对象中的实例变量-可能导致非线程安全"><a href="#多个线程-共同去竞争访问对象中的实例变量-可能导致非线程安全" class="headerlink" title="多个线程,共同去竞争访问对象中的实例变量,可能导致非线程安全"></a>多个线程,共同去竞争访问<strong>对象中的实例变量</strong>,可能导致非线程安全</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HasSelfPrivateNum</span></span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> num=<span class="number">0</span>;  <span class="comment">//num是本类的实例变量,可能出现非线程安全问题!!!</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span>  <span class="title">add</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">     <span class="keyword">try</span>&#123;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span>(name.equals(<span class="string">"a"</span>)&#123;</span><br><span class="line">             num =<span class="number">100</span>;</span><br><span class="line">         &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">             num =<span class="number">200</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     System.out.println(<span class="string">"num=="</span>+num);    </span><br><span class="line">         </span><br><span class="line">     &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">     </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h4 id="结论"><a href="#结论" class="headerlink" title="结论:"></a>结论:</h4><blockquote>
<p>只有<strong>共享的资源</strong>才可能出现非线程安全性问题,需要同步化…就像方法内部的变量,根本不可能共享,所以说没必要同步化</p>
</blockquote>
<h4 id="解决非线程安全问解决"><a href="#解决非线程安全问解决" class="headerlink" title="解决非线程安全问解决"></a>解决非线程安全问解决</h4><blockquote>
<p>这一问题引入了<strong>Synchronized</strong>关键字,让出现非线程安全问题的方法,保持前后的同步,让线程拿到<strong>对象锁(this对象锁)</strong>,当某一个线程进去后,其他线程只能等它释放对象锁之后,获取到对象锁在进入同步方法(Synchronized可以保证它修饰的方法实现原子性的操作)</p>
</blockquote>
<blockquote>
<p><strong>拓展</strong>：Ａ线程持有object对象的锁,B线程可以异步的调用object对象中的非Synchronized类型的方法</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HasSelfPrivateNum</span></span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> num=<span class="number">0</span>;  <span class="comment">//num是本类的实例变量,可能出现非线程安全问题!!!</span></span><br><span class="line">  <span class="function">Synchronized <span class="keyword">public</span> <span class="keyword">void</span>  <span class="title">add</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">     <span class="keyword">try</span>&#123;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span>(name.equals(<span class="string">"a"</span>)&#123;</span><br><span class="line">             num =<span class="number">100</span>;</span><br><span class="line">         &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">             num =<span class="number">200</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     System.out.println(<span class="string">"num=="</span>+num);    </span><br><span class="line">         </span><br><span class="line">     &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">     </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h4 id="多个对象多个锁"><a href="#多个对象多个锁" class="headerlink" title="多个对象多个锁"></a>多个对象多个锁</h4><blockquote>
<p>比如说,分别给<strong>两个线程</strong>分别去访问<strong>同一个类</strong>的<strong>两个不同不对象</strong>的<strong>同名同步方法</strong>,结果不是顺序执行,而是异步执行的…  </p>
</blockquote>
<h4 id="结论-1"><a href="#结论-1" class="headerlink" title="结论:"></a>结论:</h4><blockquote>
<p>关键字Synchronized获取到的锁<strong>全部是对象锁</strong>,而不是把一段代码或者一个方法当作锁!真出现了多个线程访问多个对象,那么JVM就会创建出,多把对象锁…</p>
</blockquote>
<h4 id="内置锁"><a href="#内置锁" class="headerlink" title="内置锁"></a>内置锁</h4><blockquote>
<p>java中每一个对象都可被当作同步的锁,这些锁就叫做内置锁</p>
</blockquote>
<h4 id="互斥锁"><a href="#互斥锁" class="headerlink" title="互斥锁"></a>互斥锁</h4><blockquote>
<p>一个线程进来之后,另一个线程不能进来</p>
</blockquote>
<h3 id="二-修饰代码块"><a href="#二-修饰代码块" class="headerlink" title="二: 修饰代码块"></a>二: 修饰代码块</h3><p>Synchronized的<strong>弊端</strong>:  </p>
<blockquote>
<p>声明方法在某些情况下是有弊端的,比如说A线程抢到了cpu的执行权,在调用同步方法执行某一个比较长的任务的,A还没来得及释放这个对象锁,紧接着B线程抢到了cpu的执行权,他也想去访问A线程访问的方法,然而B线程拿不到这个对象锁,所以被拒绝访问,因此B线程必须等待较长的时间</p>
</blockquote>
<p><strong>同步代码块语法:</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(Object)&#123;</span><br><span class="line">    <span class="comment">//同步执行的任务</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><strong>sychronized</strong>代码块里面的方法是同步的,另一个线程只有等待当前线程执行完这个代码块之后,才能执行此代码块</p>
</blockquote>
<p><strong>使用同步代码块解决同步方法的弊端,提升效率 一半同步一半异步!</strong>–&gt;<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> task&#123;</span><br><span class="line">    <span class="comment">//类的实例属性  --&gt; 共享资源</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> a;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> b;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        ....  <span class="comment">// 非共享资源</span></span><br><span class="line">        ....  <span class="comment">// 非共享资源</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>)&#123;</span><br><span class="line">            a++；</span><br><span class="line">            b++；</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(InterruptedExceotion e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>可以看到,我们只是把可能出现非线程的共享资源放在同步代码块中…   </p>
</blockquote>
<blockquote>
<p><strong>当一个线程访问object的一个Synchronized(this){}同步代码块里面的内容时,另一个线程可以访问此object对象中的非synchronized代码块!!!</strong></p>
</blockquote>
<blockquote>
<p>也就是一半同步,一半异步,<strong>不在同步代码块中的代码,就是异步执行,在同步代码块中的代码,就是同步执行!</strong></p>
</blockquote>
<h4 id="Synchronized代码块的本身具有同步性-而且-Synchronized代码块之间也具有同步性"><a href="#Synchronized代码块的本身具有同步性-而且-Synchronized代码块之间也具有同步性" class="headerlink" title="Synchronized代码块的本身具有同步性,而且,Synchronized代码块之间也具有同步性!"></a>Synchronized代码块的本身具有同步性,而且,Synchronized代码块之间也具有同步性!</h4><blockquote>
<p>当一个线程访问object对象中的Synchronized代码块的时候,其他的任何线程对object的其他任何Synchronized同步代码块的访问也是阻塞的,<strong>这也说明Synchronized同步代码块和Synchronized修饰的方法一样,使用的对象监视器是一个</strong></p>
</blockquote>
<h4 id="将任意对象-作为对象监视器"><a href="#将任意对象-作为对象监视器" class="headerlink" title="将任意对象,作为对象监视器:"></a>将任意对象,作为对象监视器:</h4><blockquote>
<p>Synchronized(<strong>非this对象</strong>){} 同步代码块可以是任意对象,这个<strong>非this对象</strong>大多数是,<strong>方法的参数,类的实例变量</strong></p>
</blockquote>
<h4 id="Synchronized-非this对象-优点"><a href="#Synchronized-非this对象-优点" class="headerlink" title="Synchronized(非this对象){}优点"></a>Synchronized(<strong>非this对象</strong>){}优点</h4><blockquote>
<p> 如果一个类中有很多的Synchronized同步方法,虽然可以实现同步,但是,会发生阻塞而降低效率,因为<strong>所有的Synchronized同步方法</strong>,他们拥有的都是<strong>this锁</strong>,而<strong>Synchronized(非this对象){}同步代码块</strong>可以使用的是<strong>非this锁</strong>,拥有不同的锁,因此他们<strong>两者之间是异步执行</strong>的,对他们自己来说<strong>又是同步执行</strong>,提升了效率</p>
</blockquote>
<h4 id="注意点"><a href="#注意点" class="headerlink" title="注意点:"></a>注意点:</h4><blockquote>
<p>同步代码块放在非同步Synchronized方法中进行声明,不能保证调用方法的线程执行同步,因为线程调用方法的顺序是无序的,虽然在同步代码块中执行的顺序依然有序,但如果有分支逻辑判断(逻辑判断没有在同步代码块中),就可能会出现脏读</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">//创建一个只能存储一个元素的集合...</span></span><br><span class="line">  List list = <span class="keyword">new</span> ArrayList();</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unsafe</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">try</span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(list.size()&lt;<span class="number">0</span>)&#123;</span><br><span class="line">           Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">          <span class="keyword">synchronized</span>()&#123; </span><br><span class="line">          list.add(<span class="string">"a"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">  &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//此段代码就会出现脏读...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//解决方法: 同步化</span></span><br><span class="line">  List list = <span class="keyword">new</span> ArrayList();</span><br><span class="line"> <span class="function"><span class="keyword">synchronized</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unsafe</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">try</span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(list.size()&lt;<span class="number">0</span>)&#123;</span><br><span class="line">           Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">          <span class="keyword">synchronized</span>()&#123; </span><br><span class="line">          list.add(<span class="string">"a"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">  &#125;<span class="keyword">catch</span>(InterruptedException e)&#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Synchronized-非this对象-总结"><a href="#Synchronized-非this对象-总结" class="headerlink" title="Synchronized(非this对象){}总结:"></a>Synchronized(<strong>非this对象</strong>){}总结:</h4><ol>
<li>在多个线程持有”对象监视器”为<strong>同一个对象的前提下</strong>,同一时间,只有一个线程可以执行synchronized(非this对象){}同步代码块中的代码.</li>
<li>同一时间,线程想去执行synchronized(非this对象){}同步代码块里面的代码,它必须拿到这个非this对象</li>
<li>其他线程调用Synchronized(非this##### 象X){}中的X的同步代码块,同步方法,依然是线程安全的.</li>
<li>在多线程访问的情况下,拥有不同对象监视器的Synchronized(){}同步代码块之间是异步执行的</li>
</ol>
<h3 id="三-修饰静态XX"><a href="#三-修饰静态XX" class="headerlink" title="三: 修饰静态XX"></a>三: 修饰静态XX</h3><h4 id="Synchronized-public-static-void-……"><a href="#Synchronized-public-static-void-……" class="headerlink" title="Synchronized public static void ……"></a>Synchronized public static void ……</h4><blockquote>
<p>Synchronized方法同样可以修饰静态方法,运行的结果证明它同样可以实现线程安全,顺序执行,但是<strong>Synchronized修饰普通方法</strong> 和 <strong>Synchronized修饰静态方法</strong>是有<strong>本质上的区别的</strong>,<strong>Synchronized修饰静态方法</strong>实际上是给<strong>Class类上锁</strong> 而前者是给<strong>this对象</strong>上锁.</p>
</blockquote>
<blockquote>
<p>换言之,两个自身顺序执行,同时出现则异步执行,(锁不同)</p>
</blockquote>
<h3 id="四-修饰同步代码块"><a href="#四-修饰同步代码块" class="headerlink" title="四 修饰同步代码块"></a>四 修饰同步代码块</h3><blockquote>
<p>Synchronized(类名.class){…}<br>作用和其修饰静态方法一样</p>
</blockquote>
<h3 id="五-synchronized锁重入"><a href="#五-synchronized锁重入" class="headerlink" title="五 . synchronized锁重入"></a>五 . synchronized锁重入</h3><ul>
<li>synchronized关键字具有锁重入的功能,也就是说,当一个线程拿到锁对象之后,当它在本synchronized方法中访问本类对象的其他synchronized方法时,它是可以重复拿到锁的!</li>
</ul>
<h3 id="六-出现异常锁自动释放"><a href="#六-出现异常锁自动释放" class="headerlink" title="六. 出现异常锁自动释放"></a>六. 出现异常锁自动释放</h3><ul>
<li>在synchronized修饰的同步方法中,若在运行时,出现了异常,对象锁会自动释放,意味着其他线程可以直接在此获取到对象锁</li>
</ul>
<h3 id="七-数据类型String的常量池特性"><a href="#七-数据类型String的常量池特性" class="headerlink" title="七. 数据类型String的常量池特性"></a>七. 数据类型String的常量池特性</h3><ul>
<li>JVM中具有String常量池缓存的功能,如下一段代码返回true</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> mainString[] avgs()&#123;</span><br><span class="line">    String a =<span class="string">"a"</span>;</span><br><span class="line">    String b = <span class="string">"a"</span>;</span><br><span class="line">    System.out.println(a==b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这也就是意味着,假如在两个线程给一个Synchronized同步代码块中传递进<strong>同样的字符串</strong>,也就意味着,他们要<strong>去竞争同一把锁</strong>,难免会出现阻塞的情况.<strong>所以绝大多数情况下,我们是不使用String字符串,来当作锁对象的</strong></p>
<h3 id="八-同步Synchronized方法的无限循环的等待和解决"><a href="#八-同步Synchronized方法的无限循环的等待和解决" class="headerlink" title="八. 同步Synchronized方法的无限循环的等待和解决"></a>八. 同步Synchronized方法的无限循环的等待和解决</h3><p>同步方法synchronized同步方法,容易造成死循环,如下代码,method永远不可能得到执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Service</span></span>&#123;</span><br><span class="line">      <span class="function"><span class="keyword">synchronized</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">methodA</span><span class="params">()</span></span>&#123;</span><br><span class="line">          System.out.println(<span class="string">"methodA Begin"</span>);</span><br><span class="line">          <span class="keyword">boolean</span> tag = <span class="keyword">true</span>;</span><br><span class="line">          <span class="keyword">while</span>(tag)&#123;&#125;</span><br><span class="line">          System.out.println(<span class="string">"methodA end"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">synchronized</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">methodB</span><span class="params">()</span></span>&#123;</span><br><span class="line">          System.out.println(<span class="string">"methodB Begin"</span>);</span><br><span class="line">          System.out.println(<span class="string">"methodB end"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>使用同步代码块解决无限循环问题</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Service</span></span>&#123;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">methodA</span><span class="params">()</span></span>&#123;</span><br><span class="line">         Object o1 = <span class="keyword">new</span> Object();</span><br><span class="line">         <span class="keyword">synchronized</span>(o1)&#123;</span><br><span class="line">             System.out.println(<span class="string">"methodA Begin"</span>);</span><br><span class="line">             <span class="keyword">boolean</span> tag = <span class="keyword">true</span>;</span><br><span class="line">             <span class="keyword">while</span>(tag)&#123;&#125;</span><br><span class="line">             System.out.println(<span class="string">"methodA end"</span>);</span><br><span class="line">         &#125;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">methodB</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Object o2 = <span class="keyword">new</span> Object();</span><br><span class="line">        <span class="keyword">synchronized</span>(o2)&#123;</span><br><span class="line">        System.out.println(<span class="string">"methodB Begin"</span>);</span><br><span class="line">        System.out.println(<span class="string">"methodB end"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="九-多线程的死锁"><a href="#九-多线程的死锁" class="headerlink" title="九 多线程的死锁"></a>九 多线程的死锁</h3><ul>
<li>多线程的死锁就是说,已经准备就绪的线程们在等待一个根本不可能被释放的锁,从而导致所有的线程任务都无法继续完成,导致了线程的假死,死锁是必须要避免的问题</li>
</ul>
<p>如下代码死锁现象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">demoSiSuo</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">demoSiSuo</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span>  Object lock1 = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="keyword">private</span>  Object lock2 = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (username.equals(<span class="string">"a"</span>))&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (lock1)&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">"a"</span>);</span><br><span class="line">                    Thread.sleep(<span class="number">200</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">synchronized</span> (lock2)&#123;</span><br><span class="line">                    <span class="comment">//do something</span></span><br><span class="line">                    System.out.println(<span class="string">"接着lock1 lock2的代码执行了"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (username.equals(<span class="string">"b"</span>))&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (lock2)&#123;</span><br><span class="line">                System.out.println(<span class="string">"b"</span>);</span><br><span class="line">                <span class="comment">//do something</span></span><br><span class="line">                <span class="keyword">synchronized</span> (lock1)&#123;</span><br><span class="line">                    <span class="comment">//do something</span></span><br><span class="line">                    System.out.println(<span class="string">"接着lock2 lock1的代码执行了"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        demoSiSuo demoSiSuo = <span class="keyword">new</span> demoSiSuo();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            demoSiSuo.set(<span class="string">"a"</span>);</span><br><span class="line">            demoSiSuo.run();</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            demoSiSuo.set(<span class="string">"b"</span>);</span><br><span class="line">            demoSiSuo.run();</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>使用JDK自带的检查死锁的工具</strong>  </p>
<p>在cmd窗口切换到bin目录,输入指令jps 找到正在运行的实例id, 输入 jstack -l [id] 可查看到<br><strong>Found 1 deadlock.</strong> </p>
<h3 id="十-锁对象的改变"><a href="#十-锁对象的改变" class="headerlink" title="十 . 锁对象的改变"></a>十 . 锁对象的改变</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">myService</span></span>&#123;</span><br><span class="line">         <span class="keyword">private</span> String lock=<span class="string">"123"</span>;</span><br><span class="line"></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">             <span class="keyword">synchronized</span> (lock)&#123;</span><br><span class="line">                 lock=<span class="string">"456"</span>;</span><br><span class="line">                 System.out.println(Thread.currentThread().getName());</span><br><span class="line">                 Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                 System.out.println(Thread.currentThread().getName()+<span class="string">"end"</span>);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        myService  j = <span class="keyword">new</span> myService();</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                j.method();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                j.method();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果<br>Thread-0<br>Thread-1<br>Thread-0end<br>Thread-1end  </p>
<ul>
<li>Thread-0把当前对象的lock属性给改了,然后自己休眠, Thread-1  拿到的是456,所以异步执行</li>
</ul>
<p><strong>当注释Thread.sleep(1000);</strong>结果如下<br>Thread-0  同步执行<br>Thread-0end<br>Thread-1<br>Thread-1end  </p>
<ul>
<li>去掉注释,他们同时抢到的锁都是123,</li>
</ul>
<blockquote>
<p>对象锁改变,依然是遵循<strong>高并发下 拥有同一把锁的同步方法或代码块会阻塞,拥有不同锁,是不会阻塞的</strong></p>
</blockquote>
<ul>
<li><strong>此外,只要锁对象不变,即使锁对象的属性改变了,运行的结果依然是同步的</strong></li>
</ul>
<h3 id="十一-从字节码的角度理解Synchronized关键字的实现原理"><a href="#十一-从字节码的角度理解Synchronized关键字的实现原理" class="headerlink" title="十一. 从字节码的角度理解Synchronized关键字的实现原理"></a>十一. 从字节码的角度理解Synchronized关键字的实现原理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">()</span></span>&#123;</span><br><span class="line">     <span class="keyword">synchronized</span>(<span class="keyword">this</span>)&#123;</span><br><span class="line">         <span class="keyword">this</span>.value++;</span><br><span class="line">         <span class="keyword">return</span> value;</span><br><span class="line">     &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="通过-javap-verbose-jishuqi-class-查看同步代码块部分的字节码"><a href="#通过-javap-verbose-jishuqi-class-查看同步代码块部分的字节码" class="headerlink" title="通过 javap -verbose jishuqi.class 查看同步代码块部分的字节码"></a>通过 javap -verbose jishuqi.class 查看同步代码块部分的字节码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">public int add();</span><br><span class="line">    descriptor: ()I</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=3, locals=3, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: dup</span><br><span class="line">         2: astore_1</span><br><span class="line">         3: monitorenter  </span><br><span class="line">         4: aload_0</span><br><span class="line">         5: dup</span><br><span class="line">         6: getfield      #2                  // Field value:I</span><br><span class="line">         9: iconst_1</span><br><span class="line">        10: iadd</span><br><span class="line">        11: putfield      #2                  // Field value:I</span><br><span class="line">        14: aload_0</span><br><span class="line">        15: getfield      #2                  // Field value:I</span><br><span class="line">        18: aload_1</span><br><span class="line">        19: monitorexit</span><br><span class="line">        20: ireturn</span><br><span class="line">        21: astore_2</span><br><span class="line">        22: aload_1</span><br><span class="line">        23: monitorexit</span><br><span class="line">        24: aload_2</span><br><span class="line">        25: athrow</span><br><span class="line">      Exception table:</span><br><span class="line">         from    to  target type</span><br><span class="line">             4    20    21   any</span><br><span class="line">            21    24    21   any</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 7: 0</span><br><span class="line">        line 8: 4</span><br><span class="line">        line 9: 14</span><br><span class="line">        line 10: 21</span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            0      26     0  this   Lcom/atGongDa/MultiThreading/Synchronized/jiShuQi;</span><br><span class="line">      StackMapTable: number_of_entries = 1</span><br><span class="line">        frame_type = 255 /* full_frame */</span><br><span class="line">          offset_delta = 21</span><br><span class="line">          locals = [ class com/atGongDa/MultiThreading/Synchronized/jiShuQi, class java/lang/Object ]</span><br><span class="line">          stack = [ class java/lang/Throwable ]</span><br></pre></td></tr></table></figure>
<h4 id="理解"><a href="#理解" class="headerlink" title="理解:"></a>理解:</h4><blockquote>
<p>synchronized代码块被<strong>monitorenter</strong>和<strong>monitorexit</strong>包围,他俩之间做出了大量的判断,字节码并不是一行一行按顺序执行的,可能碰到ifle会跳转,碰到异常,查询异常表后跳转…最后锁一定会被释放</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">3: monitorenter  </span><br><span class="line">`  ....</span><br><span class="line">23: monitorexit</span><br></pre></td></tr></table></figure>
<h2 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h2><h3 id="1-volatile概览"><a href="#1-volatile概览" class="headerlink" title="1 volatile概览:"></a>1 volatile概览:</h3><ul>
<li>是一个轻量级的锁,保证了变量在多个线程中的可见性</li>
</ul>
<p>volatile通过<strong>加入内存屏障</strong>和<strong>禁止重排序</strong>优化来实现</p>
<ul>
<li><p>对volatile变量进行写操作的时候,会在写操作前加入一条store屏障指令,将本地内存中的共享变量的值,刷新会主内存</p>
</li>
<li><p>对volatile变量进行读操作的时候,会在读操作前加入一条load屏障指令,从主内存中读</p>
</li>
</ul>
<h3 id="2-volatile-amp-synchronized"><a href="#2-volatile-amp-synchronized" class="headerlink" title="2 volatile &amp; synchronized"></a>2 volatile &amp; synchronized</h3><ul>
<li>volatile 修饰类的属性,它的作用就是 <strong>强制从公共堆栈中获取变量的值,而不是从线程的私有数据栈中获取变量的值</strong></li>
<li>volatile 只能修饰属性,—–synchronized修饰方法,代码块</li>
<li>多线程访问volatile,<strong>不会发生阻塞</strong> ,——Synchronized会发生堵塞</li>
<li>volatile 保证了线程的数据的可见性,也就是说,他可以保证线程始终如一的获取volatile属性的最新值!但是如果在对这个变量进行了其他操作,比如i++,那么volatile就变的没有任何意义,非线程安全.  <ul>
<li>i++是非原子性操作:<ul>
<li>从内存中取出i的值</li>
<li>计算i的值</li>
<li>将i的值写回内存</li>
</ul>
</li>
</ul>
</li>
<li>synchronized保证了线程的同步性,安全性</li>
<li>volatile不具备原子性—-Synchronized可以实现原子性</li>
<li><strong>synchronized代码块拥有volatile关键字的特性</strong>,既能保证数据的可见性,又能保证互斥性</li>
</ul>
<blockquote>
<p>再次重申:<strong>volatile解决的是变量在多个线程之间的可见性, synchronized解决的是多个线程之间访问资源的同步性</strong></p>
</blockquote>
<blockquote>
<p>我们完全可以使用Synchronized替代volatile 但是 后者不一定能替代前者,比如在获取变量的时候进行++操作,非原子性,导致非线程安全!</p>
</blockquote>
<h3 id="3-前行知识补充"><a href="#3-前行知识补充" class="headerlink" title="3 前行知识补充:"></a>3 前行知识补充:</h3><blockquote>
<p>把JVM的运行环境该变成 -server, 当JVM运行在Server环境下,为了提高线程的效率,线程获取到的 类的属性值时,始终在自己的私有堆栈中获取,但是当它去更改类的属性值的时候,改变的确是公共堆栈中的属性!,<strong>也就是说,它获取到的属性值,就是一开始从公共堆栈中复制过去的值,不曾,也不能修改</strong>,</p>
</blockquote>
<h3 id="4-那么想同步数据怎么办"><a href="#4-那么想同步数据怎么办" class="headerlink" title="4 那么想同步数据怎么办?"></a>4 那么想同步数据怎么办?</h3><p>这也是volatile关键字出现的必要,<strong>保证了多个线程之间 属性的可见性</strong> –&gt; <strong>强制从公共堆栈中获取变量的值,而不是从线程的私有数据栈中获取变量的值</strong></p>
<h3 id="4-1-volatile解决同步死循环"><a href="#4-1-volatile解决同步死循环" class="headerlink" title="4.1 volatile解决同步死循环"></a>4.1 volatile解决同步死循环</h3><p>直接运行下面一段代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">demo01</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> tag= <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">methodA</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(tag==<span class="keyword">true</span>)&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"methodA  end..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTag</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.tag=<span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        demo01 demo01 = <span class="keyword">new</span> demo01();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            demo01.methodA();</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            demo01.setTag();</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"main endl..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接运行结果:<br>main endl…<br>methodA  end…  </p>
<blockquote>
<p>更改JVM运行参数  -server再次运行</p>
</blockquote>
<p>结果:<br>main endl;</p>
<blockquote>
<p>更改JVM运行参数  -server再次运行,并将tag用volalite修饰</p>
</blockquote>
<p>结果:<br>main endl…<br>methodA  end…<br>验证了volatile实现了多个线程之间数据的可见性</p>
<h3 id="4-2验证Synchronized代码块实现了数据的可见性"><a href="#4-2验证Synchronized代码块实现了数据的可见性" class="headerlink" title="4.2验证Synchronized代码块实现了数据的可见性"></a>4.2验证Synchronized代码块实现了数据的可见性</h3><p>将mathodA()进行如下修改</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">methodA</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(tag==<span class="keyword">true</span>)&#123;</span><br><span class="line">            String string = <span class="keyword">new</span> String();</span><br><span class="line">            <span class="keyword">synchronized</span> (string)&#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"methodA  end..."</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-3-volatile常用的情景"><a href="#4-3-volatile常用的情景" class="headerlink" title="4.3 volatile常用的情景"></a>4.3 volatile常用的情景</h3><blockquote>
<p>使用volatile做标记变量,如下代码,假设线程2执行前必须要等线程1做好初始化工作</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">volatile</span> <span class="keyword">boolean</span> tag = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//线程1: </span></span><br><span class="line">Context = loadContext();</span><br><span class="line">tag=<span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//线程2:</span></span><br><span class="line"><span class="keyword">while</span>(!tag)&#123;</span><br><span class="line">    sleep();</span><br><span class="line">&#125;</span><br><span class="line">doSomethingWithContext();</span><br></pre></td></tr></table></figure>
<h3 id="4-4-用于安全发布对象时的双重检测禁止指令的重排序"><a href="#4-4-用于安全发布对象时的双重检测禁止指令的重排序" class="headerlink" title="4.4 用于安全发布对象时的双重检测禁止指令的重排序"></a>4.4 用于安全发布对象时的双重检测禁止指令的重排序</h3><h3 id="5-volatile原理"><a href="#5-volatile原理" class="headerlink" title="5 volatile原理"></a>5 volatile原理</h3><p>硬盘–&gt;内存–&gt;CPU的缓存</p>
<p>volatile关键字起作用,依赖的是<strong>Lock指令</strong></p>
<ul>
<li>在多处理器的系统上:<ul>
<li>将处理器<strong>缓存行</strong>里面的内容,写回到系统内存</li>
<li>这个操作同时会使其他线程cpu的缓存里面存储的对应数据失效,故,不得不重新去内存中加载最新的数据</li>
</ul>
</li>
</ul>
<p>上图,从左到右,运算速度越来越高,每个线程都有属于自己的缓存,</p>
<blockquote>
<p>大量使用volatile关键字,会降低CPU缓存的使用量,增加内存的储存量,进而导致程序运行效率降低!</p>
</blockquote>
<hr>
<p><strong>参考书籍&lt;&lt;java多线程编程核心技术&gt;&gt; 高洪岩著</strong></p>

    </div>
</div>

<div class="cube-article-nav">
    <ul>
        
        <li class="prev">
            <a href="/2019/01/17/多线程四 线程之间的通信/">
                <i class="cube-icon cube-prev" aria-hidden="true"></i>
                多线程四 线程之间的通信
            </a>
        </li>
        
        
        <li class="next">
            <a href="/2019/01/10/多线程二 基本技能/">
                多线程二 基本技能
                <i class="cube-icon cube-next" aria-hidden="true"></i>
            </a>
        </li>
        
    </ul>
</div>


<!-- TODO 根据theme.comment的内容进行入口选择 -->



        </div>
        <div class="cube-right">
            

<div class="cube-search cube-sidebar" id="cube-search">
    <div class="search-container">
        <input type="text" placeholder="Search" class="cube-search-input" id="cube-search-input">
        <i class="cube-icon cube-icon-search cube-search-submit" aria-hidden="true"></i>
    </div>
    <!-- TODO 通过给window赋一个全局变量，通过脚本赋值 -->
</div>
<script>
    (function (window) {
        'use strict';
        window.searchModule = {}
        window.searchModule.JSONUrl = '/content.json'
        window.searchModule.rootUrl = '/'
    })(window)
</script>
<div class="cube-search-form">
    <div class="cube-search-control">
        <input type="text" placeholder="Search" class="search-input">
        <a class="close-button">
            <i class="cube-icon cube-close" aria-hidden="true"></i>
        </a>
    </div>
    <div class="cube-search-result"></div>
</div>


<div class="cube-author cube-sidebar" id="cube-author">
    
    
    <span>赐我白日梦</span>
    
    
    <a title="随笔">随笔</a>
    
    <div class="count">
        <a class="count articles"><span>45</span>Article</a>
        <a class="count tags"><span>21</span>Tags</a>
        <a class="count categories"><span>20</span>Categories</a>
    </div>
</div>



<div class="cube-music cube-sidebar" id="cube-music">
    <div class="cube-player aplayer" id="cube-player"></div>
</div>
<script>
    (function (window) {
        window.musicModule = {}
        window.musicModule.musicConfig = '{"narrow":false,"autoplay":false,"showlrc":3,"theme":"#b7daff","mutex":true,"mode":"circulation","preload":"auto","listmaxheight":"513px","music":[{"title":"Dear friends","author":"TRIPLANE","url":"http://cube-1252774894.cosgz.myqcloud.com/music/source/TRIPLANE - Dear friends.mp3","lrc":"http://cube-1252774894.cosgz.myqcloud.com/music/lrc/Dear friends - TRIPLANE.lrc","pic":"http://cube-1252774894.cosgz.myqcloud.com/music/image/TRIPLANE - Dear friends.jpg"},{"title":"Butter-Fly","author":"和田光司","url":"http://cube-1252774894.cosgz.myqcloud.com/music/source/和田光司 - Butter-Fly (ピアノヴァージョン).mp3","lrc":"http://cube-1252774894.cosgz.myqcloud.com/music/lrc/Butter-Fly (ピアノヴァージョン) - 和田光司.lrc","pic":"http://cube-1252774894.cosgz.myqcloud.com/music/image/和田光司 - Butter-Fly (ピアノヴァージョン).jpg"},{"title":"宵闇花火","author":"葉月ゆら","url":"http://cube-1252774894.cosgz.myqcloud.com/music/source/葉月ゆら - 宵闇花火.mp3","lrc":"http://cube-1252774894.cosgz.myqcloud.com/music/lrc/宵闇花火 - 葉月ゆら.lrc","pic":"http://cube-1252774894.cosgz.myqcloud.com/music/image/葉月ゆら - 宵闇花火.jpg"}]}'
        window.musicModule.lrcConfig = {
            open: 'Open Lyrics',
            close: 'Close Lyrics'
        }
    })(window)
</script>



<div class="cube-recent-posts cube-sidebar" id="cube-recent-posts">
    <div class="title">
        <a>Recent Posts</a>
    </div>
    <ul class="list">
        
        
        <li>
            <!-- TODO 如果文章要显示图片，那么在front-matter上添加preview属性(url or path) -->
            
            <div class="normal">
                <p class="index first">
                    <span>1</span>
                </p>
                <p class="title">
                    <a href="/2019/06/07/TCP-IP-协议与-HTTP协议/" title="TCP/IP 协议与 HTTP协议">TCP/IP 协议与 HTTP协议</a>
                </p>
            </div>
            
        </li>
        
        
        
        <li>
            <div class="normal">
                <p class="index">
                    <span>2</span>
                </p>
                <p class="title">
                    <a href="/2019/05/25/腾讯短信-Springboot-Redis-实现短信验证注册/" title="腾讯短信+Springboot+Redis 实现短信验证注册">腾讯短信+Springboot+Redis 实现短信验证注册</a>
                </p>
            </div>
        </li>
        
        
        
        <li>
            <div class="normal">
                <p class="index">
                    <span>3</span>
                </p>
                <p class="title">
                    <a href="/2019/05/15/ubuntu16搭建文件服务器/" title="ubuntu16搭建文件服务器">ubuntu16搭建文件服务器</a>
                </p>
            </div>
        </li>
        
        
        
        <li>
            <div class="normal">
                <p class="index">
                    <span>4</span>
                </p>
                <p class="title">
                    <a href="/2019/04/23/JS-实现动态轮播图/" title="JS 实现动态轮播图">JS 实现动态轮播图</a>
                </p>
            </div>
        </li>
        
        
        
        <li>
            <div class="normal">
                <p class="index">
                    <span>5</span>
                </p>
                <p class="title">
                    <a href="/2019/04/22/PLSQL/" title="PLSQL">PLSQL</a>
                </p>
            </div>
        </li>
        
        
    </ul>
</div>



<div class="cube-categories cube-sidebar" id="cube-categories">
    <div class="title">
        <a href="/categories">Categories</a>
    </div>
    <div class="cube-boxs">
        
        
        <div class="cube-box ">
            <a href="/categories/Oracle/">#Oracle</a>
        </div>
        
        
        <div class="cube-box ">
            <a href="/categories/Elasticsearch/">#Elasticsearch</a>
        </div>
        
        
        <div class="cube-box ">
            <a href="/categories/Hibernate-Validator/">#Hibernate-Validator</a>
        </div>
        
        
        <div class="cube-box ">
            <a href="/categories/Linux/">#Linux</a>
        </div>
        
        
        <div class="cube-box-bg ">
            <a href="/categories/mysql/">#mysql</a>
        </div>
        
        
        <div class="cube-box ">
            <a href="/categories/Redis/">#Redis</a>
        </div>
        
        
        <div class="cube-box ">
            <a href="/categories/SpringMvc/">#SpringMvc</a>
        </div>
        
        
        <div class="cube-box-bg ">
            <a href="/categories/Thymeleaf/">#Thymeleaf</a>
        </div>
        
        
        <div class="cube-box ">
            <a href="/categories/nginx/">#nginx</a>
        </div>
        
        
        <div class="cube-box-bg ">
            <a href="/categories/C/">#C++</a>
        </div>
        
        
        <div class="cube-box ">
            <a href="/categories/java/">#java</a>
        </div>
        
        
        <div class="cube-box ">
            <a href="/categories/JWT/">#JWT</a>
        </div>
        
        
        <div class="cube-box ">
            <a href="/categories/多线程/">#多线程</a>
        </div>
        
        
        <div class="cube-box ">
            <a href="/categories/Java/">#Java</a>
        </div>
        
        
        <div class="cube-box ">
            <a href="/categories/JVM/">#JVM</a>
        </div>
        
        
        <div class="cube-box-bg ">
            <a href="/categories/JavaScript/">#JavaScript</a>
        </div>
        
        
        <div class="cube-box ">
            <a href="/categories/RabbitMQ/">#RabbitMQ</a>
        </div>
        
        
        <div class="cube-box-bg ">
            <a href="/categories/爬虫/">#爬虫</a>
        </div>
        
        
        <div class="cube-box ">
            <a href="/categories/mybatis/">#mybatis</a>
        </div>
        
        
        <div class="cube-box-bg ">
            <a href="/categories/Spring/">#Spring</a>
        </div>
        
    </div>
</div>



<div class="cube-tagcloud cube-sidebar" id="cube-tagcloud">
    <div class="title">
        <a href="/tags">Tagcloud</a>
    </div>
    <div class="cube-boxs">
        
        
        <div class="cube-box ">
            <a href="/tags/Oracle/">#Oracle</a>
        </div>
        
        
        <div class="cube-box-bg ">
            <a href="/tags/Elasticsearch/">#Elasticsearch</a>
        </div>
        
        
        <div class="cube-box ">
            <a href="/tags/Hibernate-Validator/">#Hibernate-Validator</a>
        </div>
        
        
        <div class="cube-box-bg ">
            <a href="/tags/Linux/">#Linux</a>
        </div>
        
        
        <div class="cube-box ">
            <a href="/tags/mysql/">#mysql</a>
        </div>
        
        
        <div class="cube-box-bg ">
            <a href="/tags/Redis/">#Redis</a>
        </div>
        
        
        <div class="cube-box ">
            <a href="/tags/SpringMvc/">#SpringMvc</a>
        </div>
        
        
        <div class="cube-box-bg ">
            <a href="/tags/Thymeleaf/">#Thymeleaf</a>
        </div>
        
        
        <div class="cube-box-bg ">
            <a href="/tags/nginx/">#nginx</a>
        </div>
        
        
        <div class="cube-box ">
            <a href="/tags/C/">#C++</a>
        </div>
        
        
        <div class="cube-box-bg ">
            <a href="/tags/nginx-FDFS/">#nginx,FDFS</a>
        </div>
        
        
        <div class="cube-box ">
            <a href="/tags/java/">#java</a>
        </div>
        
        
        <div class="cube-box ">
            <a href="/tags/JWT/">#JWT</a>
        </div>
        
        
        <div class="cube-box ">
            <a href="/tags/多线程/">#多线程</a>
        </div>
        
        
        <div class="cube-box ">
            <a href="/tags/Java/">#Java</a>
        </div>
        
        
        <div class="cube-box ">
            <a href="/tags/JVM/">#JVM</a>
        </div>
        
        
        <div class="cube-box-bg ">
            <a href="/tags/JavaScript/">#JavaScript</a>
        </div>
        
        
        <div class="cube-box ">
            <a href="/tags/RabbitMQ/">#RabbitMQ</a>
        </div>
        
        
        <div class="cube-box ">
            <a href="/tags/爬虫/">#爬虫</a>
        </div>
        
        
        <div class="cube-box ">
            <a href="/tags/mybatis/">#mybatis</a>
        </div>
        
        
        <div class="cube-box ">
            <a href="/tags/Spring/">#Spring</a>
        </div>
        
    </div>
</div>



<div class="cube-links cube-sidebar" id="cube-links">
    <div class="title">
        <a>Links</a>
    </div>
    <ul class="list">
        
        <li>
            
            
            <img src="http://cube-1252774894.cosgz.myqcloud.com/links/GitHub.png">
            
            <a href="https://github.com/ZEROKISEKI" target="_blank">GitHub</a>
        </li>
        
        <li>
            
            
            <img src="http://cube-1252774894.cosgz.myqcloud.com/links/Coding.png">
            
            <a href="https://coding.net/u/SORA1" target="_blank">Coding</a>
        </li>
        
        <li>
            
            
            <img src="http://cube-1252774894.cosgz.myqcloud.com/links/SF.png">
            
            <a href="https://segmentfault.com/u/aonosora" target="_blank">SF社区</a>
        </li>
        
        <li>
            
            
            <img src="http://cube-1252774894.cosgz.myqcloud.com/links/开发者头条.png">
            
            <a href="https://toutiao.io/u/148070" target="_blank">开发者头条</a>
        </li>
        
    </ul>
</div>



<div class="cube-friend-links cube-sidebar" id="cube-friend-links">
    <div class="title">
        <a>Friend Links</a>
    </div>
    <ul class="list">
        
        <li>
            <!-- TODO change avatar.png to friend.png-->
            <img src="http://cube-1252774894.cosgz.myqcloud.com/friend_links/micblo.png">
            <a href="https://blog.micblo.com/" target="_blank">罗大佬</a>
        </li>
        
        <li>
            <!-- TODO change avatar.png to friend.png-->
            <img src="http://cube-1252774894.cosgz.myqcloud.com/friend_links/DIYgod.jpg">
            <a href="https://www.anotherhome.net/" target="_blank">DIYgod</a>
        </li>
        
        <li>
            <!-- TODO change avatar.png to friend.png-->
            <img src="/images/friend_links.jpg ">
            <a href="https://aonosora.com/" target="_blank">咪西西の部落格</a>
        </li>
        
    </ul>
</div>


        </div>
    </div>
</div>
<footer class="cube-footer">
    
© 2017 赐我白日梦

<br>
Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>.&nbsp;Theme by <a href="https://github.com/ZEROKISEKI" target="_blank">AONOSORA</a>
</footer>
<!-- inject:script -->
<script src="/js/script.js"></script>
<!-- endinject -->
<div class="cube-loading out"></div>
</body>
</html>